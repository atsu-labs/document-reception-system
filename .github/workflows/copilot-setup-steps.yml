name: Copilot Agent Setup Steps

# This workflow is designed for Copilot Agent to set up an ephemeral testing environment
# It includes D1 database setup, dependency installation, and test execution

on:
  workflow_dispatch:
  pull_request:
    branches: ['**']

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  setup-and-test:
    name: Setup D1 Database and Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Setup environment variables
        working-directory: backend
        run: |
          # Create .dev.vars for local D1 testing
          cat > .dev.vars << EOF
          JWT_SECRET=${{ secrets.JWT_SECRET || 'test-jwt-secret-for-ci-only-do-not-use-in-production' }}
          DATABASE_PATH=./test.db
          EOF
          echo "âœ… Environment variables configured"
      
      - name: Setup D1 database (local mode)
        working-directory: backend
        run: |
          echo "ðŸ—„ï¸ Setting up D1 database in local mode..."
          
          # Apply migrations to local D1
          pnpm wrangler d1 migrations apply document-reception-system --local || {
            echo "âš ï¸ Migration failed or no migrations to apply"
          }
          
          echo "âœ… D1 database setup completed"
      
      - name: Seed D1 database (optional)
        working-directory: backend
        continue-on-error: true
        run: |
          echo "ðŸŒ± Seeding D1 database..."
          pnpm db:seed:d1 --local || echo "âš ï¸ Seeding failed - continuing without seed data"
      
      - name: Run linter
        run: pnpm lint
        continue-on-error: true
      
      - name: Run tests
        run: pnpm test
      
      - name: Build backend
        working-directory: backend
        run: pnpm build
      
      - name: Build frontend
        working-directory: frontend
        run: pnpm build
      
      - name: Verify D1 database (optional)
        working-directory: backend
        continue-on-error: true
        run: |
          echo "ðŸ” Verifying D1 database..."
          pnpm db:verify:d1 --local || echo "âš ï¸ Verification skipped"
      
      - name: Summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Environment setup completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… D1 database configured (local mode)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests executed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build completed" >> $GITHUB_STEP_SUMMARY
