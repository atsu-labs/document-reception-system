/**
 * D1 Seed Data Export Script
 * 
 * **D1-FIRST POLICY**
 * Exports seed data as SQL format suitable for D1 injection.
 * This creates SQL INSERT statements that can be executed via wrangler.
 * 
 * Usage:
 *   pnpm db:export-seed
 *   wrangler d1 execute document-reception-db --remote --file=./seed-export.sql
 */

import { randomUUID } from 'crypto';
import bcrypt from 'bcryptjs';
import * as fs from 'fs';
import * as path from 'path';

console.log('ðŸ“¦ D1ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...');
console.log('');

async function exportSeed() {
  const sqlStatements: string[] = [];
  
  // Helper function to escape SQL string values
  const escapeSqlString = (str: string): string => {
    return str.replace(/'/g, "''");
  };
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
  sqlStatements.push('-- D1 Seed Data Export');
  sqlStatements.push('-- Generated at: ' + new Date().toISOString());
  sqlStatements.push('-- DO NOT EDIT THIS FILE MANUALLY');
  sqlStatements.push('');
  
  try {
    // 1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    console.log('ðŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...');
    const workflowTemplateId = randomUUID();
    sqlStatements.push('-- Workflow Templates');
    sqlStatements.push(
      `INSERT INTO workflow_templates (id, name, statuses, created_at, updated_at) VALUES ('${workflowTemplateId}', '${escapeSqlString('æ¨™æº–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼')}', '${escapeSqlString(JSON.stringify(['å—ä»˜', 'å‡¦ç†ä¸­', 'æ¤œæŸ»', 'å®Œäº†']))}', datetime('now'), datetime('now'));`
    );
    sqlStatements.push('');

    // 2. éƒ¨ç½²
    console.log('ðŸ¢ éƒ¨ç½²ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...');
    const deptIds = {
      general: randomUUID(),
      engineering: randomUUID(),
      inspection: randomUUID(),
      management: randomUUID(),
    };

    sqlStatements.push('-- Departments');
    sqlStatements.push(
      `INSERT INTO departments (id, code, name, parent_id, is_active, sort_order, created_at, updated_at) VALUES ('${deptIds.general}', 'DEPT001', '${escapeSqlString('ç·å‹™éƒ¨')}', NULL, 1, 1, datetime('now'), datetime('now'));`
    );
    sqlStatements.push(
      `INSERT INTO departments (id, code, name, parent_id, is_active, sort_order, created_at, updated_at) VALUES ('${deptIds.engineering}', 'DEPT002', '${escapeSqlString('å·¥å‹™éƒ¨')}', NULL, 1, 2, datetime('now'), datetime('now'));`
    );
    sqlStatements.push(
      `INSERT INTO departments (id, code, name, parent_id, is_active, sort_order, created_at, updated_at) VALUES ('${deptIds.inspection}', 'DEPT003', '${escapeSqlString('æ¤œæŸ»éƒ¨')}', NULL, 1, 3, datetime('now'), datetime('now'));`
    );
    sqlStatements.push(
      `INSERT INTO departments (id, code, name, parent_id, is_active, sort_order, created_at, updated_at) VALUES ('${deptIds.management}', 'DEPT004', '${escapeSqlString('ç®¡ç†éƒ¨')}', NULL, 1, 4, datetime('now'), datetime('now'));`
    );
    sqlStatements.push('');

    // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼
    console.log('ðŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...');
    const userIds = {
      admin: randomUUID(),
      senior: randomUUID(),
      general: randomUUID(),
    };

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: password123 ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–
    const defaultPasswordHash = await bcrypt.hash('password123', 10);

    sqlStatements.push('-- Users');
    sqlStatements.push(
      `INSERT INTO users (id, username, password_hash, display_name, role, department_id, is_active, created_at, updated_at) VALUES ('${userIds.admin}', 'admin', '${escapeSqlString(defaultPasswordHash)}', '${escapeSqlString('ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼')}', 'ADMIN', '${deptIds.management}', 1, datetime('now'), datetime('now'));`
    );
    sqlStatements.push(
      `INSERT INTO users (id, username, password_hash, display_name, role, department_id, is_active, created_at, updated_at) VALUES ('${userIds.senior}', 'senior1', '${escapeSqlString(defaultPasswordHash)}', '${escapeSqlString('ä¸Šä½ãƒ¦ãƒ¼ã‚¶ãƒ¼')}', 'SENIOR', '${deptIds.engineering}', 1, datetime('now'), datetime('now'));`
    );
    sqlStatements.push(
      `INSERT INTO users (id, username, password_hash, display_name, role, department_id, is_active, created_at, updated_at) VALUES ('${userIds.general}', 'user1', '${escapeSqlString(defaultPasswordHash)}', '${escapeSqlString('ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼')}', 'GENERAL', '${deptIds.general}', 1, datetime('now'), datetime('now'));`
    );
    sqlStatements.push('');

    // 4. å±Šå‡ºç¨®é¡ž
    console.log('ðŸ“„ å±Šå‡ºç¨®é¡žãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...');
    const notificationTypeIds = {
      construction: randomUUID(),
      repair: randomUUID(),
      inspection: randomUUID(),
    };

    sqlStatements.push('-- Notification Types');
    sqlStatements.push(
      `INSERT INTO notification_types (id, code, name, description, has_inspection, has_content_field, workflow_template_id, is_active, sort_order, created_at, updated_at) VALUES ('${notificationTypeIds.construction}', 'NT001', '${escapeSqlString('å·¥äº‹å±Š')}', '${escapeSqlString('å»ºè¨­å·¥äº‹ã«é–¢ã™ã‚‹å±Šå‡º')}', 1, 1, '${workflowTemplateId}', 1, 1, datetime('now'), datetime('now'));`
    );
    sqlStatements.push(
      `INSERT INTO notification_types (id, code, name, description, has_inspection, has_content_field, workflow_template_id, is_active, sort_order, created_at, updated_at) VALUES ('${notificationTypeIds.repair}', 'NT002', '${escapeSqlString('ä¿®ç¹•å±Š')}', '${escapeSqlString('ä¿®ç¹•å·¥äº‹ã«é–¢ã™ã‚‹å±Šå‡º')}', 1, 1, '${workflowTemplateId}', 1, 2, datetime('now'), datetime('now'));`
    );
    sqlStatements.push(
      `INSERT INTO notification_types (id, code, name, description, has_inspection, has_content_field, workflow_template_id, is_active, sort_order, created_at, updated_at) VALUES ('${notificationTypeIds.inspection}', 'NT003', '${escapeSqlString('æ¤œæŸ»ä¾é ¼')}', '${escapeSqlString('æ¤œæŸ»ã«é–¢ã™ã‚‹ä¾é ¼')}', 0, 1, '${workflowTemplateId}', 1, 3, datetime('now'), datetime('now'));`
    );
    sqlStatements.push('');

    // 5. ã‚µãƒ³ãƒ—ãƒ«å±Šå‡ºãƒ‡ãƒ¼ã‚¿
    console.log('ðŸ“ ã‚µãƒ³ãƒ—ãƒ«å±Šå‡ºãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...');
    const notificationIds = {
      notification1: randomUUID(),
      notification2: randomUUID(),
    };

    const today = new Date().toISOString().split('T')[0];
    const futureDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    sqlStatements.push('-- Notifications');
    sqlStatements.push(
      `INSERT INTO notifications (id, notification_type_id, notification_date, receiving_department_id, processing_department_id, property_name, content, inspection_date, inspection_department_id, completion_date, current_status, created_by, created_at, updated_at, updated_by) VALUES ('${notificationIds.notification1}', '${notificationTypeIds.construction}', '${today}', '${deptIds.general}', '${deptIds.engineering}', '${escapeSqlString('ã‚µãƒ³ãƒ—ãƒ«ç‰©ä»¶A')}', '${escapeSqlString('æ–°ç¯‰å·¥äº‹ã®å±Šå‡ºã§ã™')}', NULL, NULL, NULL, '${escapeSqlString('å—ä»˜')}', '${userIds.general}', datetime('now'), datetime('now'), '${userIds.general}');`
    );
    sqlStatements.push(
      `INSERT INTO notifications (id, notification_type_id, notification_date, receiving_department_id, processing_department_id, property_name, content, inspection_date, inspection_department_id, completion_date, current_status, created_by, created_at, updated_at, updated_by) VALUES ('${notificationIds.notification2}', '${notificationTypeIds.repair}', '${today}', '${deptIds.general}', '${deptIds.engineering}', '${escapeSqlString('ã‚µãƒ³ãƒ—ãƒ«ç‰©ä»¶B')}', '${escapeSqlString('å¤–å£ä¿®ç¹•ã®å±Šå‡ºã§ã™')}', '${futureDate}', '${deptIds.inspection}', NULL, '${escapeSqlString('å‡¦ç†ä¸­')}', '${userIds.general}', datetime('now'), datetime('now'), '${userIds.senior}');`
    );
    sqlStatements.push('');

    // 6. å±Šå‡ºå±¥æ­´
    console.log('ðŸ“Š å±Šå‡ºå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...');
    sqlStatements.push('-- Notification History');
    sqlStatements.push(
      `INSERT INTO notification_history (id, notification_id, status_from, status_to, changed_by, comment, changed_at) VALUES ('${randomUUID()}', '${notificationIds.notification1}', NULL, '${escapeSqlString('å—ä»˜')}', '${userIds.general}', '${escapeSqlString('æ–°è¦å±Šå‡ºå—ä»˜')}', datetime('now'));`
    );
    sqlStatements.push(
      `INSERT INTO notification_history (id, notification_id, status_from, status_to, changed_by, comment, changed_at) VALUES ('${randomUUID()}', '${notificationIds.notification2}', NULL, '${escapeSqlString('å—ä»˜')}', '${userIds.general}', '${escapeSqlString('æ–°è¦å±Šå‡ºå—ä»˜')}', datetime('now'));`
    );
    sqlStatements.push(
      `INSERT INTO notification_history (id, notification_id, status_from, status_to, changed_by, comment, changed_at) VALUES ('${randomUUID()}', '${notificationIds.notification2}', '${escapeSqlString('å—ä»˜')}', '${escapeSqlString('å‡¦ç†ä¸­')}', '${userIds.senior}', '${escapeSqlString('å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ')}', datetime('now'));`
    );
    sqlStatements.push('');

    // SQLãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—
    const outputPath = path.join(process.cwd(), 'seed-export.sql');
    fs.writeFileSync(outputPath, sqlStatements.join('\n'), 'utf-8');

    console.log('âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†ï¼');
    console.log(`ðŸ“ å‡ºåŠ›å…ˆ: ${outputPath}`);
    console.log('');
    console.log('ðŸ“Œ D1ã¸ã®æŠ•å…¥æ–¹æ³•:');
    console.log('  # ãƒ­ãƒ¼ã‚«ãƒ«D1ã§ãƒ†ã‚¹ãƒˆ:');
    console.log('  wrangler d1 execute document-reception-db --local --file=./seed-export.sql');
    console.log('');
    console.log('  # æœ¬ç•ªD1ã«æŠ•å…¥:');
    console.log('  wrangler d1 execute document-reception-db --remote --file=./seed-export.sql');
    console.log('');
    console.log('ðŸ“Œ åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:');
    console.log('  ç®¡ç†è€…: username=admin, password=password123');
    console.log('  ä¸Šä½ãƒ¦ãƒ¼ã‚¶ãƒ¼: username=senior1, password=password123');
    console.log('  ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼: username=user1, password=password123');
  } catch (error) {
    console.error('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    throw error;
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
exportSeed()
  .then(() => {
    process.exit(0);
  })
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
